{% extends 'dashboard_admin.html' %}
{% block dashboard_content %}

<h2 style="color:#003b95; margin-top:0; text-align:left;">Alle boekingen
    <link rel="stylesheet" href="{{ url_for('static', filename='css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/cards.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/tables.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/forms.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}">
</h2>

<div class="filter-panel">
    <form action="{{ url_for('dashboard_admin') }}" method="get" class="filter-form">
        <div class="filter-grid">
            <div class="filter-field" style="flex:2;">
                <label for="zoekterm">Zoekterm</label>
                <input type="text"
                       id="zoekterm"
                       name="zoekterm"
                       placeholder="Zoek op huurder, email, telefoon, adres, stadâ€¦"
                       value="{{ filters.zoekterm }}">
            </div>

            <div class="filter-field">
                <label for="status_boeking">Status</label>
                <select id="status_boeking" name="status_boeking">
                    <option value="">Alle statussen</option>
                    {% set status_opties = ['in afwachting', 'betaald', 'geannuleerd'] %}
                    {% for status in status_opties %}
                        <option value="{{ status }}"
                                {% if filters.status_boeking == status %}selected{% endif %}>
                            {{ status.title() }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="filter-field">
                <label for="aantal_personen">Aantal personen</label>
                <input type="number"
                       id="aantal_personen"
                       name="aantal_personen"
                       min="1"
                       placeholder="vb. 2"
                       value="{{ filters.aantal_personen }}">
            </div>

            <div class="filter-field">
                <label for="periode_start">Startdatum</label>
                <input type="date"
                       id="periode_start"
                       name="periode_start"
                       value="{{ filters.periode_start }}">
            </div>

            <div class="filter-field">
                <label for="periode_eind">Einddatum</label>
                <input type="date"
                       id="periode_eind"
                       name="periode_eind"
                       value="{{ filters.periode_eind }}">
            </div>
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn-primary">Filters toepassen</button>
            {% if filters.zoekterm or filters.status_boeking or filters.aantal_personen or filters.periode_start or filters.periode_eind %}
                <a href="{{ url_for('dashboard_admin') }}"
                   class="btn-secondary"
                   style="text-decoration:none; display:flex; align-items:center;">
                    Wissen
                </a>
            {% endif %}
        </div>
    </form>
</div>

<div class="booking-wrapper">
<table class="booking-table">
    <thead>
        <tr>
            <th>Huurder</th>
            <th>Email</th>
            <th>Telefoon</th>
            <th>Kot</th>
            <th>Aantal personen</th>
            <th>Voorkeuren/Opmerkingen</th>
            <th>Status</th>
            <th>Periode</th>
            <th>Acties</th>
        </tr>
    </thead>

    <tbody>
        {% for boeking in boekingen %}
            {% set huurder = boeking.huurder if boeking.huurder else None %}
            {% set gebruiker = boeking.huurder.gebruiker if boeking.huurder else None %}
            {% set is_cancelled = boeking.status_boeking and 'geannuleerd' in boeking.status_boeking.lower() %}

            <tr class="{% if is_cancelled %}cancelled{% endif %}">
                <td>{{ gebruiker.naam if gebruiker else 'n.v.t.' }}</td>
                <td>{{ gebruiker.email if gebruiker else 'n.v.t.' }}</td>

                <td>
                    {% if gebruiker and gebruiker.telefoon %}
                        {{ gebruiker.telefoon | format_phone }}
                    {% else %}
                        n.v.t.
                    {% endif %}
                </td>

                <td>
                    {{ boeking.kot.adres if boeking.kot else 'n.v.t.' }},
                    {{ boeking.kot.stad if boeking.kot else '' }}
                </td>

                <td>{{ boeking.aantal_personen }}</td>
                <td>{{ huurder.voorkeuren if huurder and huurder.voorkeuren else 'n.v.t.' }}</td>
                {% set status_text = boeking.status_boeking or 'n.v.t.' %}
                {% set status_lower = status_text.lower() %}
                {% set status_class = 'cancelled' if 'geannuleerd' in status_lower
                    else 'confirmed' if 'betaald' in status_lower
                    else 'pending' if 'afwachting' in status_lower
                    else '' %}

                <td>
                    <span class="status-chip {{ status_class }}">{{ status_text }}</span>
                </td>

                {% set start = boeking.startdatum %}
                {% set eind = boeking.einddatum %}

                <td>
                    {% if start or eind %}
                        {% set start_str = start.strftime('%Y-%m-%d') if start else 'n.v.t.' %}
                        {% set eind_str = eind.strftime('%Y-%m-%d') if eind else 'n.v.t.' %}
                        {{ start_str }} t.e.m. {{ eind_str }}

                        {% if start and eind %}
                            {% set dagen = (eind - start).days %}
                            {% if dagen < 1 %}{% set dagen = 1 %}{% endif %}
                            ({{ dagen }} dagen)
                        {% endif %}
                    {% else %}
                        n.v.t.
                    {% endif %}
                </td>
                <td class="actions">
                    <form action="{{ url_for('admin_delete_boeking', boeking_id=boeking.boeking_id) }}"
                          method="post"
                          onsubmit="return confirm('Boeking annuleren?');">
                        <button type="submit"
                                class="btn-danger-small"
                                {% if is_cancelled %}disabled{% endif %}>
                            {% if is_cancelled %}Geannuleerd{% else %}Annuleer{% endif %}
                        </button>
                    </form>
                </td>
            </tr>

        {% else %}
            <tr><td colspan="9" style="text-align:center; padding:20px;">Geen boekingen gevonden.</td></tr>
        {% endfor %}
    </tbody>
 </table>
</div>

{% endblock %}
