{% extends 'dashboard_admin.html' %}
{% block dashboard_content %}

<h2 style="color:#003b95; margin-top:0;">Alle koten</h2>

<style>
    .filter-panel {
        margin-bottom: 20px;
        background: white;
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 15px 25px rgba(0,0,0,0.07);
        border: 1px solid rgba(0,59,149,0.08);
    }

    .filter-form {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .filter-grid {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
    }

    .filter-field {
        flex: 1;
        min-width: 200px;
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .filter-field label {
        font-size: 0.8rem;
        font-weight: 600;
        color: #002a70;
        text-transform: uppercase;
        letter-spacing: 0.04em;
    }

    .filter-field input {
        padding: 10px 14px;
        border-radius: 10px;
        border: 1px solid #cfd8ea;
        font-size: 0.95rem;
    }

    .filter-actions {
        display: flex;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: flex-end;
        align-items: center;
    }

    .btn-primary {
        background-color: #0071c2;
        border: none;
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-primary:hover {
        background-color: #005999;
    }

    .btn-secondary {
        background: #e0e0e0;
        border: none;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        color: #003b95;
    }

    .btn-secondary:hover {
        background: #d0d0d0;
    }

    .btn-danger {
        background-color: #c62828;
        border: none;
        color: white;
        padding: 10px 16px;
        border-radius: 8px;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-danger:hover {
        background-color: #a71d1d;
    }

    .table-scroll {
        width: 100%;
        overflow-x: auto;
        border-radius: 16px;
        padding-bottom: 8px;
    }

    /* Moderne tabel styling zoals andere paginaâ€™s */
    .kot-table {
        width: 100%;
        min-width: 1250px;
        border-collapse: separate;
        border-spacing: 0;
        margin-top: 1rem;
        background: white;
        border-radius: 16px;
        overflow: hidden;
        box-shadow: 0 25px 40px rgba(0,0,0,0.08);
        font-size: 0.92rem;
        border: 1px solid rgba(0,59,149,0.12);
    }

    .kot-table thead {
        background: linear-gradient(135deg, #f0f6ff, #dfe9ff);
    }

    .kot-table th {
        padding: 14px 16px;
        font-weight: 700;
        color: #002a70;
        border-bottom: 1px solid rgba(0,59,149,0.15);
        vertical-align: top;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        font-size: 0.82rem;
    }

    .kot-table td {
        padding: 14px 16px;
        border-bottom: 1px solid #e6e6e6;
        color: #2f2f2f;
        vertical-align: top;
    }

    .kot-table tbody tr:nth-child(even) {
        background: #f9fbff;
    }

    .kot-table tbody tr:hover {
        background: #eef5ff;
    }

    .kot-table tr:last-child td {
        border-bottom: none;
    }

    .kot-table th.numeric,
    .kot-table td.numeric {
        text-align: right;
        font-variant-numeric: tabular-nums;
        white-space: nowrap;
    }

    .kot-table td.numeric small {
        display: block;
        text-align: right;
        color: #5c6b80;
    }

    .kot-photo {
        border-radius: 8px;
        border: 1px solid #ddd;
    }

    .btn-small {
        background: #0071c2;
        border: none;
        padding: 8px 14px;
        color: white;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
    }
    .btn-small:hover {
        background: #005999;
    }

    .btn-small.danger {
        background: #c62828;
    }

    .btn-small.danger:hover {
        background: #a71d1d;
    }

    .action-cell {
        display: flex;
        flex-direction: column;
        gap: 8px;
        min-width: 120px;
    }

    .action-cell form {
        margin: 0;
    }
</style>

<div class="filter-panel">
    <form action="{{ url_for('dashboard_admin_koten') }}" method="get" class="filter-form">
        <div class="filter-grid">
            <div class="filter-field" style="flex:2;">
                <label for="zoekterm">Zoekterm</label>
                <input type="text"
                       id="zoekterm"
                       name="zoekterm"
                       placeholder="Zoek op adres, eigenaar, stad, student..."
                       value="{{ filters.zoekterm }}">
            </div>

            <div class="filter-field">
                <label for="min_capaciteit">Min. capaciteit</label>
                <input type="number"
                       id="min_capaciteit"
                       name="min_capaciteit"
                       min="0"
                       placeholder="vb. 2"
                       value="{{ filters.min_capaciteit }}">
            </div>

            <div class="filter-field">
                <label for="max_capaciteit">Max. capaciteit</label>
                <input type="number"
                       id="max_capaciteit"
                       name="max_capaciteit"
                       min="0"
                       placeholder="vb. 6"
                       value="{{ filters.max_capaciteit }}">
            </div>

            <div class="filter-field">
                <label for="min_omzet">Min. totale omzet (&euro;)</label>
                <input type="number"
                       id="min_omzet"
                       name="min_omzet"
                       min="0"
                       step="0.01"
                       placeholder="vb. 500"
                       value="{{ filters.min_omzet }}">
            </div>

            <div class="filter-field">
                <label for="max_omzet">Max. totale omzet (&euro;)</label>
                <input type="number"
                       id="max_omzet"
                       name="max_omzet"
                       min="0"
                       step="0.01"
                       placeholder="vb. 7500"
                       value="{{ filters.max_omzet }}">
            </div>
        </div>

        <div class="filter-actions">
            <button type="submit" class="btn-primary">Filters toepassen</button>
            {% if filters.zoekterm or filters.min_capaciteit or filters.max_capaciteit or filters.min_omzet or filters.max_omzet %}
                <a href="{{ url_for('dashboard_admin_koten') }}"
                   class="btn-secondary"
                   style="text-decoration:none; display:flex; align-items:center;">
                    Wissen
                </a>
            {% endif %}
        </div>
    </form>
</div>

<p style="font-size:0.9rem; color:#555; margin-bottom:0;">
    Toeristenbelasting wordt automatisch berekend aan een vast tarief van 
    {{ "%.0f"|format(tourist_tax_rate * 100) }}% van de totale omzet.
</p>

<div class="table-scroll">
    <table class="kot-table">
        <thead>
            <tr>
                <th>Adres</th>
                <th>Stad</th>
                <th>Eigenaar</th>
                <th>Capaciteit</th>
                <th>Foto</th>
                <th>Beschrijving</th>
                <th class="numeric">Omzet per nacht</th>
                <th class="numeric">Totale omzet</th>
                <th class="numeric">EGW-kosten</th>
                <th class="numeric">Toeristenbelasting</th>
                <th class="numeric">Na belasting</th>
                <th>Acties</th>
            </tr>
        </thead>

        <tbody>
            {% for kot in koten %}
                <tr>
                    <td>{{ kot.adres }}</td>
                    <td>{{ kot.stad }}</td>

                    <td>
                        {% set eigenaar = None %}
                        {% if kot.kotbaas and kot.kotbaas.gebruiker %}
                            {% set eigenaar = kot.kotbaas.gebruiker %}
                        {% elif kot.student and kot.student.gebruiker %}
                            {% set eigenaar = kot.student.gebruiker %}
                        {% endif %}

                        {% if eigenaar %}
                            <strong>{{ eigenaar.naam }}</strong><br>
                            <span>Email: {{ eigenaar.email or "n.v.t." }}</span><br>
                            <span>Tel: {{ eigenaar.telefoon or "n.v.t." }}</span>
                        {% else %}
                            Onbekend
                        {% endif %}
                    </td>

                    <td>{{ kot.aantal_slaapplaatsen or 'n.v.t.' }}</td>

                    {% set stats = kot_statistieken.get(kot.kot_id) if kot_statistieken else None %}

                    <td>
                        {% if kot.foto %}
                            <img src="{{ kot.foto }}" width="80" class="kot-photo">
                        {% else %}
                            n.v.t.
                        {% endif %}
                    </td>

                    <td>{{ kot.beschrijving or 'n.v.t.' }}</td>

                    <td class="numeric">&euro;{{ "%.2f"|format(stats.omzet_per_nacht if stats else 0) }}</td>
                    <td class="numeric">&euro;{{ "%.2f"|format(stats.totale_omzet if stats else 0) }}</td>

                    {% set egw_share = stats.egw_aandeel_omzet if stats else 0 %}
                    {% set egw_month = stats.egw_per_maand if stats else (kot.egwkosten or 0) %}
                    {% set egw_night = stats.egw_per_nacht if stats else ((kot.egwkosten or 0) / 30 if (kot.egwkosten or 0) else 0) %}

                    <td class="numeric">
                        &euro;{{ "%.2f"|format(egw_share) }}
                        <small>
                            &euro;{{ "%.2f"|format(egw_month) }} / maand<br>
                            &euro;{{ "%.2f"|format(egw_night) }} / nacht
                        </small>
                    </td>

                    {% set tax_amount = stats.toeristenbelasting if stats else 0 %}

                    <td class="numeric">&euro;{{ "%.2f"|format(tax_amount) }}</td>

                    <td class="numeric">&euro;{{ "%.2f"|format(stats.omzet_na_belasting if stats else 0) }}</td>

                    <td class="action-cell">
                        <a href="{{ url_for('admin_kot_edit', kot_id=kot.kot_id) }}">
                            <button class="btn-small">Bewerk</button>
                        </a>
                        <form action="{{ url_for('admin_delete_kot', kot_id=kot.kot_id) }}"
                              method="post"
                              onsubmit="return confirm('Weet je zeker dat je dit kot en alle boekingen wil verwijderen?');">
                            <button type="submit" class="btn-small danger">Verwijder</button>
                        </form>
                    </td>
                </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% endblock %}
